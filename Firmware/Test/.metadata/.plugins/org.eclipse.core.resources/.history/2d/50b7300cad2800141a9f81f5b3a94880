/*
 * Func_Sistema.c
 *	Descripción: 
 *	Aquí se ejecutan las funciones propias del sistema
 *  Created on: Aug 20, 2014
 *      Author: DeLeon
 */


#include "Cpu.h"
#include "Events.h"
#include "Global.h"
#include "Leds.h"

/* Prototipos de funciones internas al módulo */
void ActivarPeriféricos(void);
void DesactivarPerifericos(void);

/*
** ===================================================================
**     Method      :  void InicioCambioTension(void)
**     Description (Extendida):
**         Inicia el PWM y el ADC para alcanzar el valor de tensión recibido
**         por SCI.
**         El PWM comienza a aumentar y esto es controlado por el ADC que
**         va sensando la tensión en la resistencia de salida. Una vez alcanza-
**         do el valor requerido el sistema se mantiene en esa tensión por 20
**         segundos, terminado este tiempo la salida vuelve a ser cero. 
**     Parameters  : None
**     Returns     :
**         ---             - The number of characters in the output
**                           buffer.
** ===================================================================
*/

void InicioCambioTension(uint16_t realizarAccion)
{
	if(realizarAccion == CAMBIANDO_PWM)
	{
		Led_Estado(CAMBIANDO_PWM);
		ActivarPerifericos();
	}
	else if(realizarAccion == TENSION_FIJA)
	{
		Led_Estado(TENSION_FIJA);
		LED_TENSION_OK_On();
		DesactivarPerifericos();
	}

	
}

/*
** ===================================================================
**     Method      :  void ActivarPeriféricos(void)
**     Description:
**         Inicializamos los periféricos y nos quedamos en un buble infinito
**         esperando que se alcance la tensión requerida. Si la misma no se 
**         alcanza en 8 segundos se deshabilitan todos los periféricos y se 
**         enciende el LED_ERROR.  
**     Parameters  : None
**     Returns     :
**         ---             - The number of characters in the output
**                           buffer.
** ===================================================================
*/
void ActivarPeriféricos(void)
{
	Iniciar_PWM();
	Iniciar_PDB();
	Iniciar_ADC();
	
	do{
		Esperar_Tension_Salida();
	}while((tensiónAlcanzada) || (timeOut));
	
	if (timeOut)
		LED_ERROR_On();
	if(tensionAlcanzada)
		modificarSalida = 2;
		
}

void DesactivarPerifericos(void)
{
	while(!Esperar_20Segundos){}
	LED_TENSION_OK_Off();
	
	Desactivar_PWM();
	Desactivar_PDB();
	Desactivar_ADC();
	
	led_Estado(ESPERANDO);
}
